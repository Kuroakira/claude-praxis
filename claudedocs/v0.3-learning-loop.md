# v0.3 Learning Loop: Inline Recording + Compound Promotion

## Overview

The core value of claude-praxis is that both the engineer and the AI get smarter over time. The current implementation has a broken learning loop — decisions made during workflows are not recorded, so "we've seen this before" detection never fires. This design fixes the loop by adding inline recording to all workflows and ensuring learnings are read at every workflow start.

## Context and Scope

### Current State (broken)

The learning loop requires 4 steps: Record → Recall → Match → Propose.

| Step | Current State | Why It's Broken |
|------|--------------|-----------------|
| Record | Only `/claude-praxis:compound` writes to learnings | Compound rarely runs → nothing is recorded |
| Recall | Only `/claude-praxis:implement` reads learnings | Design and debug don't check past knowledge |
| Match | Free-form text in learnings.md | Hard to detect "same situation as before" |
| Propose | code-quality-rules self-evolution | Works in theory, but Record is empty so there's nothing to propose from |

### The Chain That Should Work

```
Workflow generates decisions → auto-write to progress.md
                                    ↓
                              compound promotes to learnings.md
                                    ↓
                              next workflow reads learnings
                                    ↓
                              "we've seen this before" → propose rule or recall context
```

## Goals

- Decisions and discoveries are recorded **as they happen**, not at session end
- All 3 main workflows read past learnings at the start
- Design Docs and Investigation Reports survive compact (saved as files)
- Compound has meaningful material to promote (progress.md is populated)

## Non-Goals

- Putting learnings metadata into Design Docs (Design Docs are for team consumption)
- Auto-running compound (it requires human judgment for promotion routing)
- Full-text search over learnings (manual recall by the AI is sufficient for now)

## Proposal

### 1. Inline Recording (Write to progress.md during workflows)

Each workflow writes to `.claude/context/progress.md` at decision points — not at the end, but as decisions happen.

**`/claude-praxis:design`**:
- After Phase 1 (Research): Record key findings and rejected approaches
- After Phase 4 (Write Doc): Record the chosen design direction and why
- Save the Design Doc itself to `design-docs/[name].md`

**`/claude-praxis:implement`**:
- After Phase 2 Step D (each task): Record decisions made and why
- After Phase 3 (Final Review): Record review findings worth remembering
- Already reads learnings in Phase 1 (no change needed)

**`/claude-praxis:debug`**:
- After Phase 3 (Diagnose): Record root cause and why it was hard to find
- After Phase 4 (Document): Save Investigation Report to `.claude/context/investigation-[name].md`

**Format for progress.md entries**:
```markdown
## [timestamp] — [workflow]: [what happened]
- Decision: [what was chosen]
- Rationale: [why — this is the key part]
- Domain: [topic tag for future matching]
```

The domain tag enables future recall. When a new task touches the same domain, the AI can search learnings by tag.

### 2. Learnings Read at Workflow Start (Recall)

Add to `/claude-praxis:design` and `/claude-praxis:debug`:
> "Check learnings before starting: Read `learnings.md` and `global-learnings.md` if they exist. When a past learning is relevant, present it with its original context."

`/claude-praxis:implement` already does this. The same pattern applies to all three.

### 3. Artifact Persistence (Survive compact)

| Artifact | Save Location | When |
|----------|--------------|------|
| Design Doc | `design-docs/[name].md` | End of `/claude-praxis:design` Phase 4 |
| Investigation Report | `.claude/context/investigation-[name].md` | End of `/claude-praxis:debug` Phase 4 |
| Implementation Plan | `.claude/context/task_plan.md` | End of `/claude-praxis:implement` Phase 1 |

These are already defined in context-persistence but not referenced by the commands.

### 4. Compound Stays As-Is

Compound's role is promotion (Flow → Stock). It doesn't need to change — the problem was that progress.md was empty. With inline recording, compound has material to work with.

The promotion routing is already well-designed:
- Project-specific → `learnings.md`
- Cross-project → `global-learnings.md`
- Universal quality rule → `code-quality-rules` self-evolution
- Framework improvement → skill/command files
- Ephemeral → discard

## Alternatives Considered

### Alternative: Auto-run compound after each workflow

| Aspect | Detail |
|--------|--------|
| How it works | Each main workflow automatically runs a lightweight compound step at the end |
| Why Proposal is preferred | Compound requires human judgment for routing. Auto-running would either skip the human (bad: wrong routing) or add a mandatory approval gate to every workflow (bad: friction). Inline recording gives compound good material without forcing it to run |
| When to reconsider | If users consistently forget to run compound even with suggestions |

### Alternative: Structured learnings with database-like search

| Aspect | Detail |
|--------|--------|
| How it works | Learnings stored as structured JSON with fields: domain, learning, rationale, date. Searched by domain tag |
| Why Proposal is preferred | Adds complexity. Domain tags in progress.md entries provide enough structure for the AI to match. Full structured search is over-engineering for the current scale |
| When to reconsider | When learnings.md exceeds 100 entries and recall quality degrades |

## Concerns

- **Will the AI actually write to progress.md?** — This is instruction-following, not enforcement via hooks. If past experience shows skills get skipped, this may need a hook-based enforcement layer
- **Domain tags may be inconsistent** — The AI chooses tags freely. "auth", "authentication", "login" could all refer to the same domain. Acceptable for now; address when it causes recall failures
- **progress.md may grow too fast** — With 3 workflows all writing, entries accumulate quickly. The existing "keep last 10 entries" rule in context-persistence handles this

## Changes Required

| File | Change |
|------|--------|
| `commands/design.md` | Add learnings read (Phase 0), progress.md writes (Phase 1, 4), Design Doc file save (Phase 4) |
| `commands/implement.md` | Add progress.md writes (Phase 2 Step D, Phase 3) |
| `commands/debug.md` | Add learnings read (Phase 0), progress.md writes (Phase 3), Investigation Report file save (Phase 4) |
